/* yocto-mongoose - Utility tool to manage mongoose connection and auto loading models. - V2.3.0 - Fri Oct 12 2018 12:16:28 GMT+0400 (+04)*/

"use strict";var _=require("lodash"),logger=require("yocto-logger"),utils=require("yocto-utils"),traverse=require("traverse"),moment=require("moment");function Crypt(t,e){this.logger=t,this.algorithm="aes256",this.hashKey="",this.Types=e,this.modelProperties={}}Crypt.prototype.setAlgorithmAndKey=function(t){return this.algorithm=_.get(t,"hashType")||this.algorithm,this.hashKey=_.get(t,"hashKey")||this.hashKey,this},Crypt.prototype.saveModelProperties=function(t){return this.modelProperties=t,this},Crypt.prototype.encrypt=function(t){if(t&&!this.isAlreadyCrypted(t)){this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Starting encrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!0);if(e)return this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Value was successfuly crypted to ",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.decrypt=function(t){if(t){this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Starting decrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!1);if(e)return this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Value is crypted so decrypted value is",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.isAlreadyCrypted=function(t){if(t){if(this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Checking if given data [",utils.obj.inspect(t),"] is already crypted"].join(" ")),this.encryptDecrypt(t,!0,!1))return this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is already crypted. Skipping this process !"].join(" ")),!0;this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is not crypted. Do crypt process !"].join(" "))}return!1},Crypt.prototype.encryptDecrypt=function(t,e,r){var i=!1,o=r?"encrypt":"decrypt";if(_.isArray(t))i=_.compact(_.map(t,function(t){return utils.crypto[o](this.hashKey,t,this.algorithm)}.bind(this))),e&&(i=!_.isEmpty(i));else{var s=_.first(Object.keys(t)),n=["$in","$nin"];i=r&&_.isObject(t)&&!_.isUndefined(s)&&(_.includes(["$eq","$gt","$gte","$lt","$lte","$ne"],s)||_.includes(n,s))?(_.includes(n,s)?_.set(t,s,_.map(_.get(t,s),function(t){return utils.crypto[o](this.hashKey,t,this.algorithm)}.bind(this))):_.set(t,s,utils.crypto[o](this.hashKey,_.get(t,s).toString(),this.algorithm)),t):_.isRegExp(t)?t:utils.crypto[o](this.hashKey,t,this.algorithm)}return i},Crypt.prototype.redisPlainEncryptDecrypt=function(t,e){var r=e?"encrypt":"decrypt";return utils.crypto[r](this.hashKey,t,this.algorithm)},Crypt.prototype.process=function(t,r){var i=this.getProperties(),o=this;return traverse(t).map(function(t){var e=o.normalizePath(this.path,!0);return _.includes(i,e)?(o.logger.verbose(["[ Crypt.process ] - Try to",r?"encrypt":"decrypt",e].join(" ")),this.update(r?o.encrypt(t):o.formatToDate(o.decrypt(t)))):this.update(o.formatToDate(t))})},Crypt.prototype.formatToDate=function(t){return _.isString(t)&&moment(t,moment.ISO_8601,!0).isValid()?new Date(t):t},Crypt.prototype.normalizePath=function(t,e){return t=t.join(".").replace(/(\d{1,})/g,"digit"),e&&(t=(t=(t=t.replace(/(\.\$\w+\.)/g,".")).replace(/(\$\w+\.digit\.)/,"")).replace(/(\$\w+\.)/,"")),t},Crypt.prototype.getProperties=function(r){r=r||this.modelProperties;var t=_.uniq(_.map(_.compact(_.map(traverse(r).paths(),function(t){var e=!1;return _.includes(t,"ym_crypt")&&(e=_.isBoolean(_.get(r,t))&&_.get(r,t)),!!e&&_.pullAll(t,["ym_crypt","type"])})),function(t){return t.join(".").replace(/\d/g,"digit")})),e=_.map(t,function(t){return t.replace(/\.digit\./g,".")});return _.uniq(_.union(t,e))},Crypt.prototype.isEnabled=function(t){return!_.isEmpty(this.getProperties(t))},Crypt.prototype.setupHook=function(o,t,e){var r=this.isEnabled(t);if(r){this.logger.verbose(["[ YMongoose.cryto.setupHook ] - Setting up hook for model [",e,"]"].join(" "));_.map([{type:"pre",method:"findOneAndUpdate",crypt:!0,update:!0},{type:"pre",method:"findByIdAndUpdate",crypt:!0,update:!0},{type:"pre",method:"update",crypt:!0,update:!0},{type:"pre",method:"save",crypt:!0,create:!0},{type:"pre",method:"find",crypt:!0,find:!0},{type:"pre",method:"findOne",crypt:!0,find:!0}],function(i){o[i.type](i.method,function(t){if(i.update){var e=o.statics.crypto().process(this.getQuery(),i.crypt),r=o.statics.crypto().process(this.getUpdate(),i.crypt);this.update(e,r)}if(i.create&&_.extend(this,o.statics.crypto().process(JSON.parse(JSON.stringify(this.toJSON())),i.crypt)),i.find&&this.where(o.statics.crypto().process(this.getQuery(),i.crypt)),_.isFunction(t))return t()})})}return this.normalizeToObject(o,r)},Crypt.prototype.normalizeToObject=function(r,t){return t?r.set("toObject",{transform:function(t,e){return r.statics.crypto().process(JSON.parse(JSON.stringify(e),!1))}}):r.set("toObject",{transform:function(t,e){return JSON.parse(JSON.stringify(e))}}),r},module.exports=function(t,e){return(_.isUndefined(t)||_.isNull(t))&&(logger.warning("[ Crypt.constructor ] - Invalid logger given. Use internal logger"),t=logger),new Crypt(t,e)};