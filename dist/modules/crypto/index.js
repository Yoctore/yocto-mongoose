/* yocto-mongoose - Utility tool to manage mongoose connection and auto loading models. - V2.2.0 */

"use strict";var _=require("lodash"),logger=require("yocto-logger"),utils=require("yocto-utils"),traverse=require("traverse");function Crypt(t,e){this.logger=t,this.algorithm="aes256",this.hashKey="",this.Types=e,this.modelProperties={}}Crypt.prototype.setAlgorithmAndKey=function(t){return this.algorithm=_.get(t,"hashType")||this.algorithm,this.hashKey=_.get(t,"hashKey")||this.hashKey,this},Crypt.prototype.saveModelProperties=function(t){return this.modelProperties=t,this},Crypt.prototype.encrypt=function(t){if(t&&!this.isAlreadyCrypted(t)){this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Starting encrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!0);if(e)return this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Value was successfuly crypted to ",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.decrypt=function(t){if(t){this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Starting decrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!1);if(e)return this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Value is crypted so decrypted value is",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.isAlreadyCrypted=function(t){if(t){if(this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Checking if given data [",utils.obj.inspect(t),"] is already crypted"].join(" ")),this.encryptDecrypt(t,!0,!1))return this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is already crypted. Skipping this process !"].join(" ")),!0;this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is not crypted. Do crypt process !"].join(" "))}return!1},Crypt.prototype.encryptDecrypt=function(t,e,r){var o=!1,i=r?"encrypt":"decrypt";return _.isArray(t)?(o=_.compact(_.map(t,function(t){return utils.crypto[i](this.hashKey,t,this.algorithm)}.bind(this))),e&&(o=!_.isEmpty(o))):o=utils.crypto[i](this.hashKey,t,this.algorithm),o},Crypt.prototype.process=function(t,r){var o=this.getProperties(),i=this;return traverse(t).map(function(t){var e=i.normalizePath(this.path,!0);return console.log("defined properties =>",o),console.log("path =>",this.path),console.log(t),console.log("path to process",e,_.includes(o,e)),_.includes(o,e)?this.update(r?i.encrypt(t):i.formatToDate(i.decrypt(t))):this.update(i.formatToDate(t))})},Crypt.prototype.formatToDate=function(t){return!_.isString(t)||_.isNumber(parseInt(t,10))||_.isNaN(Date.parse(t))?t:new Date(t)},Crypt.prototype.normalizePath=function(t,e){return t=t.join(".").replace(/\d/g,"digit"),e&&(t=(t=(t=t.replace(/(\.\$\w+\.)/g,".")).replace(/(\$\w+\.digit\.)/,"")).replace(/(\$\w+\.)/,"")),t},Crypt.prototype.getProperties=function(t){t=t||this.modelProperties;var e=_.uniq(_.map(_.compact(_.map(traverse(t).paths(),function(t){return!!_.includes(t,"ym_crypt")&&_.pullAll(t,["ym_crypt","type"])})),function(t){return t.join(".").replace(/\d/g,"digit")})),r=_.map(e,function(t){return t.replace(/\.digit\./g,".")});return _.uniq(_.union(e,r))},Crypt.prototype.isEnabled=function(t){return!_.isEmpty(this.getProperties(t))},Crypt.prototype.setupHook=function(i,t,e){if(this.isEnabled(t)){this.logger.verbose(["[ YMongoose.cryto.setupHook ] - Setting up hook for model [",e,"]"].join(" "));_.map([{type:"pre",method:"findOneAndUpdate",crypt:!0,update:!0},{type:"pre",method:"findByIdAndUpdate",crypt:!0,update:!0},{type:"pre",method:"update",crypt:!0,update:!0},{type:"pre",method:"save",crypt:!0,create:!0},{type:"pre",method:"find",crypt:!0,find:!0},{type:"pre",method:"findOne",crypt:!0,find:!0}],function(o){i.set("toObject",{transform:function(t,e){return i.statics.crypto().process(JSON.parse(JSON.stringify(e),o.crypt))}}),i[o.type](o.method,function(t){if(o.update){var e=i.statics.crypto().process(this.getQuery(),o.crypt),r=i.statics.crypto().process(this.getUpdate(),o.crypt);console.log("Query",e),console.log("Update",r),this.update(e,r)}if(o.create&&_.extend(this,i.statics.crypto().process(JSON.parse(JSON.stringify(this.toJSON())),o.crypt)),o.find&&"pre"===o.type&&this.where(i.statics.crypto().process(this.getQuery(),o.crypt)),_.isFunction(t))return t()})})}return i},module.exports=function(t,e){return(_.isUndefined(t)||_.isNull(t))&&(logger.warning("[ Crypt.constructor ] - Invalid logger given. Use internal logger"),t=logger),new Crypt(t,e)};