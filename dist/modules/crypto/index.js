/* yocto-mongoose - Utility tool to manage mongoose connection and auto loading models. - V2.2.0 */

"use strict";var _=require("lodash"),logger=require("yocto-logger"),utils=require("yocto-utils"),traverse=require("traverse"),moment=require("moment");function Crypt(t,e){this.logger=t,this.algorithm="aes256",this.hashKey="",this.Types=e,this.modelProperties={}}Crypt.prototype.setAlgorithmAndKey=function(t){return this.algorithm=_.get(t,"hashType")||this.algorithm,this.hashKey=_.get(t,"hashKey")||this.hashKey,this},Crypt.prototype.saveModelProperties=function(t){return this.modelProperties=t,this},Crypt.prototype.encrypt=function(t){if(t&&!this.isAlreadyCrypted(t)){this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Starting encrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!0);if(e)return this.logger.verbose(["[ YMongoose.cryto.encrypt ] - Value was successfuly crypted to ",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.decrypt=function(t){if(t){this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Starting decrypt process with algo [",this.algorithm,"] for data ",utils.obj.inspect(t)].join(" "));var e=this.encryptDecrypt(t,!1,!1);if(e)return this.logger.verbose(["[ YMongoose.cryto.decrypt ] - Value is crypted so decrypted value is",utils.obj.inspect(e)].join(" ")),e}return t},Crypt.prototype.isAlreadyCrypted=function(t){if(t){if(this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Checking if given data [",utils.obj.inspect(t),"] is already crypted"].join(" ")),this.encryptDecrypt(t,!0,!1))return this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is already crypted. Skipping this process !"].join(" ")),!0;this.logger.verbose(["[ YMongoose.cryto.isAlreadyCrypted ] - Given data",utils.obj.inspect(t),"is not crypted. Do crypt process !"].join(" "))}return!1},Crypt.prototype.encryptDecrypt=function(t,e,r){var o=!1,i=r?"encrypt":"decrypt";return _.isArray(t)?(o=_.compact(_.map(t,function(t){return utils.crypto[i](this.hashKey,t,this.algorithm)}.bind(this))),e&&(o=!_.isEmpty(o))):o=utils.crypto[i](this.hashKey,t,this.algorithm),o},Crypt.prototype.redisPlainEncryptDecrypt=function(t,e){var r=e?"encrypt":"decrypt";return utils.crypto[r](this.hashKey,t,this.algorithm)},Crypt.prototype.process=function(t,r){var o=this.getProperties(),i=this;return traverse(t).map(function(t){var e=i.normalizePath(this.path,!0);return _.includes(o,e)?(i.logger.verbose(["[ Crypt.process ] - Try to",r?"encrypt":"decrypt",e].join(" ")),this.update(r?i.encrypt(t):i.formatToDate(i.decrypt(t)))):this.update(i.formatToDate(t))})},Crypt.prototype.formatToDate=function(t){return _.isString(t)&&moment(t,moment.ISO_8601,!0).isValid()?new Date(t):t},Crypt.prototype.normalizePath=function(t,e){return t=t.join(".").replace(/(\d{1,})/g,"digit"),e&&(t=(t=(t=t.replace(/(\.\$\w+\.)/g,".")).replace(/(\$\w+\.digit\.)/,"")).replace(/(\$\w+\.)/,"")),t},Crypt.prototype.getProperties=function(r){r=r||this.modelProperties;var t=_.uniq(_.map(_.compact(_.map(traverse(r).paths(),function(t){var e=!1;return _.includes(t,"ym_crypt")&&(e=_.isBoolean(_.get(r,t))&&_.get(r,t)),!!e&&_.pullAll(t,["ym_crypt","type"])})),function(t){return t.join(".").replace(/\d/g,"digit")})),e=_.map(t,function(t){return t.replace(/\.digit\./g,".")});return _.uniq(_.union(t,e))},Crypt.prototype.isEnabled=function(t){return!_.isEmpty(this.getProperties(t))},Crypt.prototype.setupHook=function(i,t,e){var r=this.isEnabled(t);if(r){this.logger.verbose(["[ YMongoose.cryto.setupHook ] - Setting up hook for model [",e,"]"].join(" "));_.map([{type:"pre",method:"findOneAndUpdate",crypt:!0,update:!0},{type:"pre",method:"findByIdAndUpdate",crypt:!0,update:!0},{type:"pre",method:"update",crypt:!0,update:!0},{type:"pre",method:"save",crypt:!0,create:!0},{type:"pre",method:"find",crypt:!0,find:!0},{type:"pre",method:"findOne",crypt:!0,find:!0}],function(o){i[o.type](o.method,function(t){if(o.update){var e=i.statics.crypto().process(this.getQuery(),o.crypt),r=i.statics.crypto().process(this.getUpdate(),o.crypt);this.update(e,r)}if(o.create&&_.extend(this,i.statics.crypto().process(JSON.parse(JSON.stringify(this.toJSON())),o.crypt)),o.find&&this.where(i.statics.crypto().process(this.getQuery(),o.crypt)),_.isFunction(t))return t()})})}return this.normalizeToObject(i,r)},Crypt.prototype.normalizeToObject=function(r,t){return t?r.set("toObject",{transform:function(t,e){return r.statics.crypto().process(JSON.parse(JSON.stringify(e),!1))}}):r.set("toObject",{transform:function(t,e){return JSON.parse(JSON.stringify(e))}}),r},module.exports=function(t,e){return(_.isUndefined(t)||_.isNull(t))&&(logger.warning("[ Crypt.constructor ] - Invalid logger given. Use internal logger"),t=logger),new Crypt(t,e)};