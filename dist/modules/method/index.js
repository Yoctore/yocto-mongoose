/* yocto-mongoose - Utility tool to manage mongoose connection and auto loading models. - V2.1.1 */
"use strict";function Method(a){this.logger=a}var glob=require("glob"),logger=require("yocto-logger"),_=require("lodash"),Schema=require("mongoose").Schema,joi=require("joi"),utils=require("yocto-utils"),stackTrace=require("stack-trace");Method.prototype.add=function(a,b,c,d,e){if(_.isString(b)&&_.isArray(c)&&!_.isEmpty(b)&&!_.isEmpty(c)&&_.isObject(a)&&a instanceof Schema&&_.isString(d)&&!_.isEmpty(d)){var f=glob.sync(["**/",d,".js"].join(""),{cwd:b,realpath:!0,nocase:!0});if(f.length>0)return _.each(f,function(b){var d=require(b);_.each(c,function(b){var c=joi.object().keys({type:joi.string().required().empty().valid(["static","method","post","pre"]),name:joi.string().required().empty(),event:joi.optional().when("type",{is:"post",then:joi.string().required().empty().valid(["init","validate","save","remove","count","find","findOne","findOneAndRemove","findOneAndUpdate","update"])}),redis:joi.object().optional().keys({enable:joi.boolean().required().default(!1),expire:joi.number().optional().min(0).default(0)})}),f=joi.validate(b,c);if(_.isNull(f.error))if(_.has(d,b.name)&&_.isFunction(d[b.name])){if(this.logger.debug(["[ Method.add ] - Method [",b.name,"] founded adding new","method"===b.type?"instance":b.type,"method for given schema"].join(" ")),"post"!==b.type&&"pre"!==b.type||!_.isString(b.event)||_.isEmpty(b.event))a[b.type](b.name,function(){return d[b.name].apply(this,arguments)});else{this.logger.debug(["[ Method.add ] - Adding [",b.type," ] hook on current schema for event [",b.event,"]"].join(" "));var g=this.logger;"post"===b.type?a.post(b.event,function(){return d[b.name].apply(this,_.flatten([arguments,g]))}):a.pre(b.event,function(a){return d[b.name].apply(this,_.flatten([arguments,g])),a()})}b.redis&&(_.isArray(a.redisExpireTimeByKey)||(a.redisExpireTimeByKey=[]),_.has(b.redis,"enable")&&b.redis.enable&&(a.redisExpireTimeByKey.push(_.set({},b.name,b.redis.expire)),a.static("redis",function(){var a=stackTrace.get(),b=a[1];_.isObject(b)&&(b=b.getFunctionName(),b=b.replace("exports.",""));var c=_.result(_.find(this.schema.redisExpireTimeByKey,b),b);return{instance:e,expire:c||0}})))}else this.logger.warning(["[ Method.add ] - Cannot found method [",b.name,"] for current model"].join(" "));else this.logger.error(["[ Method.add ] - Cannot add method for item",utils.obj.inspect(b),f.error].join(" "))}.bind(this))}.bind(this)),a;this.logger.warning(["[ Method.add ] - Given directory path for","Methods seems to be empty.","Cannot add method on schema."].join(" "))}else this.logger.error("[ Method.add ] - cannot process invalid path / name or schema given.");return!1},module.exports=function(a){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ Method.constructor ] - Invalid logger given. Use internal logger"),a=logger),new Method(a)};